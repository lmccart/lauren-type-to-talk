<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LAUREN</title>
    <link rel="shortcut icon" type="image/jpg" href="../favicon.ico"/>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script  src="/__/firebase/9.17.1/firebase-app-compat.js"></script>
    <script  src="/__/firebase/9.17.1/firebase-auth-compat.js"></script>
    <script  src="/__/firebase/9.17.1/firebase-firestore-compat.js"></script>
    <script  src="/__/firebase/9.17.1/firebase-storage-compat.js"></script>
    <script  src="/__/firebase/9.17.1/firebase-performance-compat.js"></script>
    <script  src="/__/firebase/init.js?useEmulator=true"></script>
    <link rel="stylesheet" href="../style.css">

  </head>
  <body>
    <header>
      <h1>&nbsp;LAUREN: Anyone Home? LAUREN: Anyone Home? LAUREN: Anyone Home? LAUREN: Anyone Home? LAUREN: Anyone Home? LAUREN: Anyone Home? LAUREN: Anyone Home? LAUREN: Anyone Home?</h1>
    </header>

    <div id="container">
      <div id="center">
          
        <div id="live-mode">
          Language:
          <select id="lang" name="lang">
            <option value="en" selected>English</option>
            <option value="de">Deutsch</option>
          </select>
          <textarea type="text" id="msg" placeholder="Type to speak..." rows="3"></textarea>
  
          <button id="send">Send</button>
        </div>

        <div id="not-live-mode">
          <p id="next-performance">The next performance will be soon!</p>
        </div>

        
    
        <footer>
          <h1>&nbsp;LAUREN: Anyone Home? LAUREN: Anyone Home? LAUREN: Anyone Home? LAUREN: Anyone Home? LAUREN: Anyone Home? LAUREN: Anyone Home? LAUREN: Anyone Home? LAUREN: Anyone Home?</h1>
        </footer>
      </div>
      <button id="live">Live</button>
      
    </div>
   

    <script>
      const app = firebase.app();
      firebase.auth().signInAnonymously().catch(error => { console.log(error); });
      firebase.auth().onAuthStateChanged(user => { 
        init();
      });
      const db = firebase.firestore(app);

      // Check for Live mode
      let isLive;
      const statusDoc = db.collection('status').doc('lauren');
      statusDoc.onSnapshot((doc) => {
        isLive = doc.data().live;
        checkUIForToggle();
        console.log(`LAUREN is ${isLive ? 'live' : 'not live'}.`);
      })

      let dateWrittenEN, dateWrittenDE;
      let nextLang = 'de';
      let langInterval;
      let langIntervalDelay = 10000;

      function init() {
        // Attach functionality to buttons
        $('#send').click(send);
        $('#live').click(toggleLive);

        checkNextPeformance();
      }

      function send() {
        let msg = $('#msg').val();
        console.log(`send ${msg}`);
        if (msg && msg.length) {
          db.collection('messages').add({text: msg, lang: $('#lang').find(":selected").val(), ts: firebase.firestore.FieldValue.serverTimestamp(), ms: new Date().getTime()}).then(() => {
            $('#msg').val("");
          });
        }
      }

      function toggleLive() {
        statusDoc.get().then((doc) => {
          isLive = doc.data().live;
          statusDoc.update({
            live: !isLive
          }).then().catch((error) => {
            console.error("Error updating document: ", error);
          });
        })
      }

      function checkUIForToggle() {
        if (isLive) {
          $('#live-mode').show();
          $('#not-live-mode').hide();
          $('#live').text("Live");
          clearInterval(langInterval);
        } else {
          $('#live-mode').hide();
          $('#not-live-mode').show();
          $('#live').text("Not Live");
          nextLang == 'de';
          // switchPerformanceLang();
          clearInterval(langInterval);
          langInterval = setInterval(switchPerformanceLang, langIntervalDelay);
        }
      }

      // function addPerformances() {
      //   for (let performance of performances) {
      //     let pDate = new Date(performance);
      //     db.collection('performances').add({
      //       dateWrittenEN: "",
      //       dateWrittenDE: "",
      //       dateUTC: firebase.firestore.Timestamp.fromDate(pDate)
      //     });
      //   }
      // }

      function checkNextPeformance() {
        const now = new Date();
        db.collection('performances')
          .where('dateUTC', '>', firebase.firestore.Timestamp.fromDate(now))
          .orderBy('dateUTC', 'asc')
          .limit(1)
          .get()
          .then((querySnapshot) => {
            if (!querySnapshot.empty) {
              const nextPerformance = querySnapshot.docs[0].data();
              console.log("Next Performance:", nextPerformance);
              ({ dateWrittenEN, dateWrittenDE } = nextPerformance);
              switchPerformanceLang();
            } else {
              console.log("No upcoming performances.");
            }
          }).catch((error) => {
            console.error("Error fetching performances: ", error);
          });
      }

      function switchPerformanceLang() {
        console.log(`switching next performance language to ${nextLang}!`)
        if (nextLang == 'en') {
          $('#next-performance').text(dateWrittenEN);
          nextLang = 'de';
        } else {
          $('#next-performance').text(dateWrittenDE);
          nextLang = 'en';
        }
      }

    </script>
  </body>
</html>
